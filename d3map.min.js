"use strict";(function(){var d3map=window.d3map||{};window.d3map=d3map;d3map.version="0.0.1";d3map.viz=function(){var config={container:undefined,data:undefined,id:"id",map:{topojson:undefined,unit:undefined,key:undefined},color:{key:undefined,domain:undefined,range:undefined,interpolate:false},hideLegend:true,scale:undefined,onclick:undefined,projection:d3.geo.mercator(),center:[-55,-15]};var valueById=d3.map();var chart=function(selection){selection.datum(config.data).each(function(data){d3.select(window).on("resize",function(){config.width=parseInt(selection.style("width"),10);config.height=parseInt(selection.style("height"),10);chart.draw()});data.forEach(function(d){var dataId=d[config.id];valueById[dataId]={};if(typeof config.color.key==="function"){valueById[dataId]["color"]=config.color.key(d)}else valueById[dataId]["color"]=parseFloat(d[config.color.key])});var colorDomain=null;if(config.color.domain!==null&&config.color.domain!==undefined){colorDomain=config.color.domain}else{colorDomain=[0,d3.max(data,function(d){var dataId=d[config.id];return valueById[dataId]["color"]})]}var color=null;if(config.color.interpolate!==undefined&&config.color.interpolate===true){color=d3.scale.linear().range(config.color.range).interpolate(d3.interpolateHcl).domain(colorDomain)}else{color=d3.scale.quantize().range(config.color.range).domain(colorDomain)}config.width=config.width||parseInt(selection.style("width"),10)||500;config.height=config.height||parseInt(selection.style("height"),10)||500;var margin={top:0,right:0,bottom:0,left:0},width=config.width-margin.left-margin.right,height=config.height-margin.top-margin.bottom;var svg=d3.select(this).selectAll("svg").data([data]);var gEnter=svg.enter().append("svg").attr("class","d3map").append("g");svg.attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom);var scale=null;if(config.scale!==null&&config.scale!==undefined){scale=config.scale}else{scale=width>height?height:width;scale=scale*1.2}var projection=config.projection.scale(scale).center(config.center).translate([width/2,height/2]);var path=d3.geo.path().projection(projection);var fmt=d3.format(",");d3.json(config.map.topojson,function(error,br){var units=topojson.feature(br,br.objects[config.map.unit]);var g=svg.select("g");var mapSelection=g.selectAll("path").data(units.features);mapSelection.enter().append("path").attr("class",config.map.unit).append("title");g.selectAll("path").attr("d",path);mapSelection.attr("fill",function(d){if(color!==null){var name=d.properties[config.map.key];if(valueById[name]!==undefined){return color(valueById[name]["color"])}}return"#F0F0F0"}).select("title").text(function(d){var name=d.properties[config.map.key];return name.toUpperCase()+": "+fmt(valueById[name]["color"])});if(typeof config.onclick==="function"){mapSelection.on("click",config.onclick)}});if(!config.hideLegend){var rawDomain=color.domain().slice().reverse();var nOfStep=5;var step=Math.ceil((rawDomain[0]-rawDomain[1])/nOfStep);var ldata=d3.range(rawDomain[1],rawDomain[0],step);var g=svg.select("g");var legend=g.selectAll(".legend").data([ldata]);var legEnter=legend.enter().append("g").attr("class","legend");var legItem=legend.selectAll(".item").data(ldata);var outerItem=legItem.enter().append("g").attr("class","item");outerItem.append("rect");outerItem.append("text");var legWidth=Math.round(config.width/nOfStep);legItem.attr("transform",function(d,i){return"translate("+(i*legWidth+i)+",0)"});legItem.select("rect").attr("x",function(d,i){if(i===0)return 1;return 2}).attr("y",config.height-8).attr("width",legWidth).attr("height",7).style("fill",function(d,i){if(i===0)return color(rawDomain[1]);else if(i===nOfStep-1)return color(rawDomain[0]);return color(d)});var fmt=d3.format(".2s");legItem.select("text").attr("x",function(d,i){return 25+i}).attr("y",config.height-20).attr("dy",".35em").style("text-anchor","end").text(function(d,i){if(i===0)return rawDomain[1];else if(i===nOfStep-1)return rawDomain[0];return d<1e3?d:fmt(d)});legItem.exit().remove()}})};chart.container=function(value){if(!arguments.length)return config.container;config.container=value;return chart};chart.width=function(value){if(!arguments.length)return config.width;config.width=value;return chart};chart.height=function(value){if(!arguments.length)return config.height;config.height=value;return chart};chart.data=function(value){if(!arguments.length)return config.data;config.data=value;return chart};chart.id=function(value){if(!arguments.length)return config.id;config.id=value;return chart};chart.map=function(value){if(!arguments.length)return config.map;config.map=value;return chart};chart.color=function(value){if(!arguments.length)return config.color;config.color=value;return chart};chart.hideLegend=function(value){if(!arguments.length)return config.hideLegend;config.hideLegend=value;return chart};chart.projection=function(value){if(!arguments.length)return config.projection;config.projection=value;return chart};chart.center=function(value){if(!arguments.length)return config.center;config.center=value;return chart};chart.scale=function(value){if(!arguments.length)return config.scale;config.scale=value;return chart};chart.onclick=function(value){if(!arguments.length)return config.onclick;config.onclick=value;return chart};chart.draw=function(){if(!config.container){console.error("Please define a container div using .container()")}else if(d3.select(config.container).empty()){console.error('Cannot find <div> on page matching: "'+config.container+'"')}else if(!config.data){console.error("Please define a data file using .data()")}else if(!config.map){console.error("Please define a topojson configuration using .map()")}else if(config.map&&(!config.map.topojson||!config.map.unit||!config.map.key)){console.error("Please specify 'key', 'topojson' and 'unit' attributes to .map()")}else if(config.color&&(!config.color.key||!config.color.range)){console.error("Please specify at least 'key' and 'range' attributes to .color()")}else{d3.select(config.container).call(chart)}return chart};return chart}})();